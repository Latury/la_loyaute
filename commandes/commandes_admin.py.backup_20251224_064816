# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â•‘                                                                             
# â•‘  ğŸ‘‘ LA LOYAUTÃ‰ - COMMANDES ADMINISTRATIVES
# â•‘
# â•‘  Commandes rÃ©servÃ©es aux administrateurs (slash commands)
# â•‘  DÃ©veloppÃ© par Latury
# â•‘  Version : 0.1.0
# â•‘
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

import discord
from discord import app_commands
from discord.ext import commands
from datetime import datetime
import asyncio

# Importation de la configuration
import configuration as config
from utilitaires.helpers import (
    creer_embed,
    creer_embed_succes,
    creer_embed_erreur,
    creer_embed_avertissement,
    formater_nombre
)
from utilitaires.logger import obtenir_stats_logs, lire_dernieres_lignes

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â•‘ ğŸ“¦ Classe 01 â€“ Cog des commandes administratives
# â•‘ Description : Contient toutes les commandes admin du bot
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
class CommandesAdmin(commands.Cog):
    """Cog contenant les commandes administratives (slash commands)"""

    def __init__(self, bot):
        """Initialise le cog des commandes admin"""

        self.bot = bot

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â•‘ ğŸ—‘ï¸ Fonction 01 â€“ Commande /clear
    # â•‘ Description : Supprime un nombre de messages dans un salon
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    @app_commands.command(
        name="clear",
        description="Supprime un nombre de messages dans le salon"
    )
    @app_commands.describe(
        nombre="Nombre de messages Ã  supprimer (max 100)"
    )
    @app_commands.checks.has_permissions(manage_messages=True)
    async def clear(self, interaction: discord.Interaction, nombre: int):
        """Supprime des messages en masse"""

        # â”€â”€ ğŸ”¹ VÃ©rification du nombre
        if nombre < 1 or nombre > config.MAX_MESSAGES_CLEAR:
            embed = creer_embed_erreur(
                titre="Erreur",
                description=f"Le nombre doit Ãªtre entre 1 et {config.MAX_MESSAGES_CLEAR}."
            )
            await interaction.response.send_message(embed=embed, ephemeral=True)
            return

        # â”€â”€ ğŸ”¹ RÃ©ponse diffÃ©rÃ©e
        await interaction.response.defer(ephemeral=True)

        try:
            # â”€â”€ ğŸ”¹ Suppression des messages
            # VÃ©rification du type de canal
            if not isinstance(interaction.channel, (discord.TextChannel, discord.Thread, discord.VoiceChannel)):
                embed = creer_embed_erreur(
                    titre="Erreur",
                    description="Cette commande ne peut Ãªtre utilisÃ©e que dans les salons textuels."
                )
                await interaction.followup.send(embed=embed, ephemeral=True)
                return

            messages_supprimes = await interaction.channel.purge(limit=nombre)

            # â”€â”€ ğŸ”¹ Confirmation
            embed = creer_embed_succes(
                titre="Messages supprimÃ©s",
                description=f"{config.EMOJI_SUCCES} **{len(messages_supprimes)}** message(s) supprimÃ©(s) avec succÃ¨s."
            )

            await interaction.followup.send(embed=embed, ephemeral=True)

            # â”€â”€ ğŸ”¹ Log de l'action
            self.bot.logger.info(
                f"ğŸ—‘ï¸ {len(messages_supprimes)} messages supprimÃ©s par {interaction.user} " +
                f"dans #{getattr(interaction.channel, 'name', 'canal inconnu')}"
            )

        except discord.Forbidden:
            embed = creer_embed_erreur(
                titre="Erreur de permissions",
                description="Je n'ai pas la permission de supprimer des messages."
            )
            await interaction.followup.send(embed=embed, ephemeral=True)

        except Exception as e:
            embed = creer_embed_erreur(
                titre="Erreur",
                description=f"Une erreur s'est produite : {str(e)}"
            )
            await interaction.followup.send(embed=embed, ephemeral=True)
            self.bot.logger.error(f"âŒ Erreur dans /clear : {e}")

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â•‘ ğŸ“ Fonction 02 â€“ Commande /logs
    # â•‘ Description : Affiche les logs rÃ©cents du bot
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    @app_commands.command(
        name="logs",
        description="Affiche les derniers logs du bot"
    )
    @app_commands.describe(
        nombre="Nombre de lignes Ã  afficher (max 50)"
    )
    @app_commands.checks.has_permissions(administrator=True)
    async def logs(self, interaction: discord.Interaction, nombre: int = 20):
        """Affiche les logs rÃ©cents"""

        # â”€â”€ ğŸ”¹ VÃ©rification du nombre
        if nombre < 1 or nombre > 50:
            embed = creer_embed_erreur(
                titre="Erreur",
                description="Le nombre doit Ãªtre entre 1 et 50."
            )
            await interaction.response.send_message(embed=embed, ephemeral=True)
            return

        # â”€â”€ ğŸ”¹ RÃ©ponse diffÃ©rÃ©e
        await interaction.response.defer(ephemeral=True)

        try:
            # â”€â”€ ğŸ”¹ RÃ©cupÃ©ration des logs
            lignes_logs = lire_dernieres_lignes(nombre)

            if not lignes_logs:
                embed = creer_embed_avertissement(
                    titre="Aucun log",
                    description="Aucun log disponible pour aujourd'hui."
                )
                await interaction.followup.send(embed=embed, ephemeral=True)
                return

            # â”€â”€ ğŸ”¹ Statistiques des logs
            stats_logs = obtenir_stats_logs()

            # â”€â”€ ğŸ”¹ Formatage des logs
            logs_texte = "".join(lignes_logs)

            # â”€â”€ ğŸ”¹ DÃ©coupage si trop long
            if len(logs_texte) > 1900:
                logs_texte = logs_texte[-1900:]
                logs_texte = "..." + logs_texte

            # â”€â”€ ğŸ”¹ CrÃ©ation de l'embed
            embed = creer_embed(
                titre="ğŸ“ Logs rÃ©cents",
                description=f"DerniÃ¨res {len(lignes_logs)} ligne(s) de logs",
                couleur=config.COULEUR_INFO
            )

            embed.add_field(
                name="ğŸ“Š Statistiques",
                value=(
                    f"**Fichiers :** {stats_logs['nombre_fichiers']}\n"
                    f"**Taille totale :** {stats_logs['taille_totale']} MB\n"
                    f"**Fichier actuel :** {stats_logs['fichier_actuel']}"
                ),
                inline=False
            )

            embed.add_field(
                name="ğŸ“„ Contenu",
                value=f"``````",
                inline=False
            )

            await interaction.followup.send(embed=embed, ephemeral=True)

        except Exception as e:
            embed = creer_embed_erreur(
                titre="Erreur",
                description=f"Impossible de rÃ©cupÃ©rer les logs : {str(e)}"
            )
            await interaction.followup.send(embed=embed, ephemeral=True)
            self.bot.logger.error(f"âŒ Erreur dans /logs : {e}")

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â•‘ âš™ï¸ Fonction 03 â€“ Commande /config
    # â•‘ Description : Affiche la configuration du bot
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    @app_commands.command(
        name="config",
        description="Affiche la configuration actuelle du bot"
    )
    @app_commands.checks.has_permissions(administrator=True)
    async def config(self, interaction: discord.Interaction):
        """Affiche la configuration du bot"""

        # â”€â”€ ğŸ”¹ CrÃ©ation de l'embed
        embed = creer_embed(
            titre="âš™ï¸ Configuration du bot",
            description=f"Configuration actuelle de **{config.NOM_BOT}**",
            couleur=config.COULEUR_PRINCIPALE
        )

        # â”€â”€ ğŸ”¹ Configuration gÃ©nÃ©rale
        embed.add_field(
            name="ğŸ® GÃ©nÃ©ral",
            value=(
                f"**Nom :** {config.NOM_BOT}\n"
                f"**Version :** {config.VERSION_BOT}\n"
                f"**DÃ©veloppeur :** {config.DEVELOPPEUR}\n"
                f"**Debug :** {'ActivÃ©' if config.DEBUG_MODE else 'DÃ©sactivÃ©'}"
            ),
            inline=True
        )

        # â”€â”€ ğŸ”¹ Configuration des commandes
        embed.add_field(
            name="ğŸ’¬ Commandes",
            value=(
                f"**Prefix base :** `{config.PREFIX_BASE}`\n"
                f"**Prefix admin :** `{config.PREFIX_ADMIN}`\n"
                f"**Timeout :** {config.TIMEOUT_COMMANDE}s\n"
                f"**Max clear :** {config.MAX_MESSAGES_CLEAR}"
            ),
            inline=True
        )

        # â”€â”€ ğŸ”¹ Configuration des logs
        embed.add_field(
            name="ğŸ“ Logs",
            value=(
                f"**Niveau :** {config.NIVEAU_LOG}\n"
                f"**Dossier :** {config.DOSSIER_LOGS}\n"
                f"**Format date :** {config.FORMAT_DATE_LOG}"
            ),
            inline=False
        )

        # â”€â”€ ğŸ”¹ Configuration des rÃ´les
        role_admin = "Non configurÃ©"
        role_modo = "Non configurÃ©"

        if config.ROLE_ADMIN_ID != 0:
            role = interaction.guild.get_role(config.ROLE_ADMIN_ID)
            role_admin = role.mention if role else f"ID: {config.ROLE_ADMIN_ID} (introuvable)"

        if config.ROLE_MODERATEUR_ID != 0:
            role = interaction.guild.get_role(config.ROLE_MODERATEUR_ID)
            role_modo = role.mention if role else f"ID: {config.ROLE_MODERATEUR_ID} (introuvable)"

        embed.add_field(
            name="ğŸ‘‘ RÃ´les",
            value=(
                f"**Admin :** {role_admin}\n"
                f"**ModÃ©rateur :** {role_modo}"
            ),
            inline=False
        )

        await interaction.response.send_message(embed=embed, ephemeral=True)

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â•‘ ğŸ”„ Fonction 04 â€“ Commande /reload
    # â•‘ Description : Recharge une extension du bot
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    @app_commands.command(
        name="reload",
        description="Recharge une extension du bot"
    )
    @app_commands.describe(
        extension="Nom de l'extension Ã  recharger"
    )
    @app_commands.checks.has_permissions(administrator=True)
    async def reload(self, interaction: discord.Interaction, extension: str):
        """Recharge une extension"""

        await interaction.response.defer(ephemeral=True)

        try:
            # â”€â”€ ğŸ”¹ Rechargement de l'extension
            await self.bot.reload_extension(extension)

            embed = creer_embed_succes(
                titre="Extension rechargÃ©e",
                description=f"L'extension `{extension}` a Ã©tÃ© rechargÃ©e avec succÃ¨s."
            )

            await interaction.followup.send(embed=embed, ephemeral=True)
            self.bot.logger.info(f"ğŸ”„ Extension rechargÃ©e : {extension} par {interaction.user}")

        except commands.ExtensionNotFound:
            embed = creer_embed_erreur(
                titre="Erreur",
                description=f"L'extension `{extension}` n'existe pas."
            )
            await interaction.followup.send(embed=embed, ephemeral=True)

        except Exception as e:
            embed = creer_embed_erreur(
                titre="Erreur",
                description=f"Erreur lors du rechargement : {str(e)}"
            )
            await interaction.followup.send(embed=embed, ephemeral=True)
            self.bot.logger.error(f"âŒ Erreur dans /reload : {e}")

    # â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    # â•‘ ğŸ›‘ Fonction 05 â€“ Commande /shutdown
    # â•‘ Description : ArrÃªte le bot proprement
    # â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    @app_commands.command(
        name="shutdown",
        description="ArrÃªte le bot proprement"
    )
    @app_commands.checks.has_permissions(administrator=True)
    async def shutdown(self, interaction: discord.Interaction):
        """ArrÃªte le bot"""

        # â”€â”€ ğŸ”¹ Confirmation
        embed = creer_embed_avertissement(
            titre="Confirmation requise",
            description="ÃŠtes-vous sÃ»r de vouloir arrÃªter le bot ?\nRÃ©agissez avec âœ… pour confirmer."
        )

        await interaction.response.send_message(embed=embed, ephemeral=True)
        message = await interaction.original_response()

        await message.add_reaction("âœ…")
        await message.add_reaction("âŒ")

        # â”€â”€ ğŸ”¹ Attente de la rÃ©action
        def check(reaction, user):
            return user == interaction.user and str(reaction.emoji) in ["âœ…", "âŒ"]

        try:
            reaction, user = await self.bot.wait_for('reaction_add', timeout=30.0, check=check)

            if str(reaction.emoji) == "âœ…":
                embed = creer_embed(
                    titre="ğŸ›‘ ArrÃªt du bot",
                    description="Le bot va s'arrÃªter dans quelques instants...",
                    couleur=config.COULEUR_ERREUR
                )
                await interaction.edit_original_response(embed=embed)

                self.bot.logger.info(f"ğŸ›‘ ArrÃªt du bot demandÃ© par {interaction.user}")

                await asyncio.sleep(2)
                await self.bot.close()
            else:
                embed = creer_embed_info(
                    titre="AnnulÃ©",
                    description="L'arrÃªt du bot a Ã©tÃ© annulÃ©."
                )
                await interaction.edit_original_response(embed=embed)

        except asyncio.TimeoutError:
            embed = creer_embed_info(
                titre="Timeout",
                description="Temps Ã©coulÃ©, l'arrÃªt a Ã©tÃ© annulÃ©."
            )
            await interaction.edit_original_response(embed=embed)

# â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
# â•‘ ğŸ“¦ Fonction setup
# â•‘ Description : Fonction requise pour charger le cog
# â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async def setup(bot):
    """Charge le cog des commandes admin"""
    await bot.add_cog(CommandesAdmin(bot))
